<script type="text/javascript" src="https://maps.googleapis.com/maps/api/js?libraries=places"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>

<style type="text/css">
      html, body { height: 100%; margin: 0; padding: 0; }
      #map { height: 100%; }
</style>



<form action="" method="get" class="search-form">

	<input type="text" id="search-input"></input>
  <button id="search-button">Find a Space!</button>
  <button id="where-am-i">By Location!</button>

</form>



<div id="map">

</div>



<script type="text/javascript">

var searchBox = new google.maps.places.Autocomplete(document.getElementById('search-input'));

google.maps.event.addListener(searchBox, 'places_changed', function() {
  var place = Autocomplete.getPlaces()[0];
});

</script>



<script type="text/javascript">

  $('#search-button').click(function (event) {
  event.preventDefault();
  geocoder = new google.maps.Geocoder();
  var locationToSearch = $('#search-input').val();
              var mapOptions = {
                zoom: 14,
                mapTypeId: google.maps.MapTypeId.ROADMAP,
                address: locationToSearch
            }

    geocoder.geocode( { 'address': locationToSearch}, function(results, status) {
      if (status == google.maps.GeocoderStatus.OK) {
        map.setCenter(results[0].geometry.location);
      } else {
        alert("Geocode was not successful for the following reason: " + status);
      }
    });        
    

    var map = new google.maps.Map(document.getElementById('map'), mapOptions);
    <% @coworks.each do |cowork| %>

      var lat = <%= cowork.latitude %>;
      var lon = <%= cowork.longitude %>;
      var latlng = new google.maps.LatLng(lat, lon); 
      
      var infowindow = new google.maps.InfoWindow(
        //'<%= link_to(cowork.name, cowork_path(cowork)) %>'
      );
      var marker = new google.maps.Marker({
      position: latlng,
      map: map
      });
      marker.setMap(map);

      marker.addListener('click', function(content) {
      infowindow.open(map, marker);
      });
    <% end %>
    google.maps.event.addDomListener(window, 'load') 

  $('.search-form').addClass("hideForm")
  $('#map').addClass("showMap")
}); 

</script>


<script type="text/javascript">

  if ("geolocation" in navigator) {
  var button = document.getElementById('where-am-i');
  button.addEventListener('click', getLocation);
} else {
  alert("Geolocation is not available")
}

function getLocation(event) {
  event.preventDefault(); 
  console.log('Getting location...'); 
  navigator.geolocation.getCurrentPosition(onLocation, onError, options);
}

var options = {
  enableHighAccuracy: true,
  timeout: 5000,
  maximumAge: 0
};

function onLocation (position) {
  console.log("Got it!");
  var lat = position.coords.latitude;
  var lon = position.coords.longitude;
  displayMap(lat, lon);
}

function onError(error) {
  console.log("Getting location failed: " + error);
}


function displayMap(lat, lon) {
  var latlng = new google.maps.LatLng(lat, lon);
    var mapOptions = {
        zoom: 16,
        center: latlng,
        mapTypeId: google.maps.MapTypeId.ROADMAP
    }
    var map = new google.maps.Map(document.getElementById('map'), mapOptions);
    google.maps.event.addDomListener(window, 'load', displayMap);

  
  var marker = new google.maps.Marker({
      position: latlng,
      map: map
    });
    marker.setMap(map);

  $('.search-form').addClass("hideForm")
  $('#map').addClass("showMap")
}

</script>


